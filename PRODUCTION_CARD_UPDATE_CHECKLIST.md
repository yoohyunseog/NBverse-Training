# 생산 카드 시스템 업데이트 체크리스트

## 개요

생산 카드 시스템의 현재 상태를 점검하고 향후 업데이트가 필요한 사항들을 정리한 문서입니다.

## ✅ 완료된 기능

### 1. 기본 기능
- [x] 카드 생산 기능
- [x] 카드 생명주기 관리 (ACTIVE, GRAY, REMOVED, OVERLAP_ACTIVE)
- [x] 히스토리 시스템 (NEW, BUY, SOLD)
- [x] 점수 및 등급 시스템 (기본 구현)
- [x] 중첩 카드 재활성
- [x] 카드 키(card_key) 기반 시스템
- [x] 메모리 캐싱 및 인덱싱
- [x] 임시 저장 파일 지원
- [x] NBverse 저장소 연동

### 2. UI 기능
- [x] PyQt6 기반 카드 위젯
- [x] 실시간 가격 추적 및 차트 표시
- [x] 실시간 손익 계산 및 표시
- [x] AI 메시지 표시
- [x] 강화학습 AI 분석 표시
- [x] 점수 차트 표시

### 3. 성능 최적화
- [x] 메모리 캐싱 (O(1) 인덱스)
- [x] 백그라운드 스레드 처리
- [x] JSON 처리 최적화 (orjson 지원)
- [x] 가격 업데이트 디바운싱

## 🔄 업데이트 필요 사항

### 1. 점수 계산 로직 고도화

**현재 상태**: 기본 점수 100점, 등급 C로 시작. 강화학습 AI가 보상 기반으로 점수 업데이트.

**업데이트 필요**:
- [ ] 거래 성과 기반 점수 계산 로직 구현
  - 손익률에 따른 점수 변동
  - 수익 금액에 따른 점수 변동
  - 거래 빈도 고려
  - 보유 기간 고려
- [ ] 점수 변동 히스토리 저장 및 분석
- [ ] 점수 기반 카드 필터링 기능
- [ ] 점수 기반 자동 정렬 기능

**파일 위치**:
- `managers/production_card_manager.py`: `_calculate_loss_rate_score()` 메서드 확장
- `workers/rl_reward_worker.py`: 보상 계산 로직 개선

### 2. 히스토리 시스템 개선

**현재 상태**: NEW, BUY, SOLD 타입 지원. 최대 100개 제한.

**업데이트 필요**:
- [ ] CANCEL 타입 추가 (매수 취소/실패 시)
- [ ] 히스토리 필터링 기능 (타입별, 기간별)
- [ ] 히스토리 통계 계산 (평균 손익률, 총 손익 등)
- [ ] 히스토리 내보내기 기능 (CSV, JSON)
- [ ] 히스토리 시각화 (차트)

**파일 위치**:
- `managers/production_card_manager.py`: `add_cancel_history()` 메서드 추가
- `managers/production_card_manager.py`: 히스토리 통계 메서드 추가

### 3. 자동 폐기 시스템 개선

**현재 상태**: 손실률 임계값(-10%), 연속 손실 5회, 평균 손실률 기반 자동 폐기.

**업데이트 필요**:
- [ ] 폐기 사유 상세 기록
- [ ] 폐기 전 경고 시스템 (임계값 근접 시 알림)
- [ ] 폐기 통계 및 분석
- [ ] 폐기 카드 복구 기능 (필요 시)
- [ ] 폐기 임계값 설정 가능 (UI에서)

**파일 위치**:
- `managers/production_card_manager.py`: `_should_auto_discard()` 메서드 개선
- `managers/discarded_card_manager.py`: 폐기 사유 상세 기록

### 4. 카드 필터링 및 정렬 기능

**현재 상태**: 활성 카드 조회, 모든 카드 조회 지원.

**업데이트 필요**:
- [ ] 점수 기반 정렬
- [ ] 등급 기반 필터링
- [ ] 타임프레임별 필터링
- [ ] 상태별 필터링 (ACTIVE, GRAY, REMOVED, OVERLAP_ACTIVE)
- [ ] 기간별 필터링 (생산 시간 기준)
- [ ] 검색 기능 (카드 ID, 카드 키, N/B ID)

**파일 위치**:
- `managers/production_card_manager.py`: 필터링 및 정렬 메서드 추가
- `ui/production_card.py`: UI에 필터링 옵션 추가

### 5. 통계 및 분석 기능

**현재 상태**: 기본적인 카드 정보 표시.

**업데이트 필요**:
- [ ] 카드별 상세 통계
  - 총 거래 횟수
  - 평균 손익률
  - 총 손익 금액
  - 승률
  - 최대 수익/손실
- [ ] 전체 카드 통계
  - 전체 카드 수
  - 활성 카드 수
  - 평균 점수
  - 등급별 분포
- [ ] 시간대별 통계
  - 일별/주별/월별 통계
  - 시간대별 성과 분석
- [ ] 통계 시각화 (차트, 그래프)

**파일 위치**:
- `managers/production_card_manager.py`: 통계 계산 메서드 추가
- `ui/production_card.py`: 통계 표시 UI 추가
- 새 파일: `utils/card_statistics.py` (통계 계산 유틸리티)

### 6. UI/UX 개선

**현재 상태**: 기본적인 카드 정보 표시.

**업데이트 필요**:
- [ ] 카드 상세 정보 모달/다이얼로그
- [ ] 히스토리 상세 보기
- [ ] 카드 편집 기능 (메모 추가 등)
- [ ] 카드 삭제 기능 (수동)
- [ ] 카드 복제 기능
- [ ] 다크 모드/라이트 모드 지원
- [ ] 반응형 레이아웃 개선
- [ ] 애니메이션 효과 개선

**파일 위치**:
- `ui/production_card.py`: UI 개선
- 새 파일: `ui/card_detail_dialog.py` (카드 상세 다이얼로그)

### 6-1. 매수/매도 UI 개선 (긴급)

**현재 상태**: 
- 매수 버튼만 있고 매도 버튼이 명시적으로 표시되지 않음
- 보유 상태가 명확하게 표시되지 않음
- 매수/매도 금액, 수량 정보가 불명확함
- 현재 포지션 정보가 보이지 않음

**업데이트 필요**:
- [ ] **보유 상태 표시 영역 추가**
  - 현재 보유 중인지, 매수 가능한지, 매도 가능한지 명확한 상태 표시
  - 상태 배지/라벨 추가 (예: "보유 중", "매수 가능", "매도 가능", "매도 완료")
  - 상태에 따른 색상 구분 (초록: 보유 중, 파랑: 매수 가능, 빨강: 매도 가능, 회색: 완료)
  
- [ ] **매도 버튼 명시적 추가**
  - 보유 중일 때만 표시되는 매도 버튼
  - 매도 버튼 스타일 (빨간색, 명확한 텍스트)
  - 매도 버튼 클릭 시 확인 다이얼로그
  
- [ ] **포지션 정보 표시 영역**
  - 현재 보유 수량 (BTC)
  - 매수 평균 가격
  - 매수 시점 표시
  - 총 매수 금액 (KRW)
  - 현재 평가 금액
  - 실시간 손익 (금액 및 %)
  - 손익 색상 구분 (수익: 초록, 손실: 빨강)
  
- [ ] **매수/매도 정보 개선**
  - 매수 버튼 옆에 예상 매수 금액 표시
  - 매도 버튼 옆에 예상 매도 금액 표시
  - 수수료 정보 명확히 표시
  - 최소/최대 매수 금액 표시
  
- [ ] **매수/매도 히스토리 표시**
  - 최근 매수/매도 내역 표시 (시간, 가격, 수량)
  - 히스토리 아이콘/배지로 시각적 구분
  - 클릭 시 상세 히스토리 다이얼로그
  
- [ ] **버튼 상태 관리**
  - 보유 중일 때: 매수 버튼 비활성화, 매도 버튼 활성화
  - 매수 가능할 때: 매수 버튼 활성화, 매도 버튼 숨김
  - 매도 완료 후: 두 버튼 모두 비활성화 또는 숨김
  - 로딩 중 상태 표시 (버튼 비활성화 + 로딩 인디케이터)
  
- [ ] **시각적 피드백 개선**
  - 버튼 호버 효과 강화
  - 클릭 시 애니메이션 효과
  - 성공/실패 시 토스트 메시지 또는 알림
  - 진행 중 상태 표시 (프로그레스바 또는 스피너)

**UI 레이아웃 제안**:
```
┌─────────────────────────────────┐
│ [보유 상태 배지]                 │
│ 🟢 보유 중 | 수량: 0.001 BTC    │
├─────────────────────────────────┤
│ 포지션 정보                      │
│ 매수 평균: 50,000,000 KRW       │
│ 현재 평가: 51,000,000 KRW       │
│ 손익: +1,000,000 KRW (+2.0%)   │
├─────────────────────────────────┤
│ [매수] [매도] [폐기]            │
│ 매수 금액: 5,000 KRW            │
│ 매도 금액: 51,000 KRW (예상)    │
└─────────────────────────────────┘
```

**파일 위치**:
- `ui/production_card.py`: 매수/매도 UI 개선 (우선순위 높음)
- `ui/production_card.py`: `setup_ui()` 메서드에 포지션 정보 영역 추가
- `ui/production_card.py`: `_update_buy_entry_price()` 메서드 개선
- `ui/production_card.py`: `_on_buy_clicked()`, `_on_sell_clicked()` 메서드 개선

### 7. 강화학습 연동 개선

**현재 상태**: 기본적인 강화학습 연동 (state, action, reward).

**업데이트 필요**:
- [ ] 더 정교한 특징값 추출
  - 기술적 지표 추가 (RSI, MACD, 볼린저 밴드 등)
  - 시장 상황 분석 (변동성, 추세 등)
- [ ] 행동 결정 로직 개선
  - 포지션 크기 조절
  - 손절/익절 가격 설정
- [ ] 학습 데이터 수집 개선
  - 더 많은 컨텍스트 정보 저장
  - 실패 케이스 분석
- [ ] 모델 성능 모니터링
  - 학습 진행 상황 표시
  - 성능 지표 추적

**파일 위치**:
- `workers/rl_worker.py`: 특징값 추출 개선
- `workers/rl_reward_worker.py`: 보상 계산 개선
- 새 파일: `ml/feature_extractor.py` (특징값 추출 유틸리티)

### 8. 성능 최적화

**현재 상태**: 기본적인 최적화 완료 (캐싱, 백그라운드 처리).

**업데이트 필요**:
- [ ] 대량 카드 처리 시 성능 개선
  - 페이지네이션
  - 가상 스크롤링
- [ ] 메모리 사용량 최적화
  - 불필요한 데이터 제거
  - 압축 저장
- [ ] 데이터베이스 인덱싱 개선
  - 복합 인덱스 추가
  - 쿼리 최적화
- [ ] 네트워크 요청 최적화
  - 배치 요청
  - 캐싱 전략 개선

**파일 위치**:
- `managers/production_card_manager.py`: 성능 최적화
- `ui/production_card.py`: UI 성능 최적화

### 9. 에러 처리 및 로깅

**현재 상태**: 기본적인 에러 처리 및 로깅.

**업데이트 필요**:
- [ ] 상세한 에러 메시지
- [ ] 에러 복구 메커니즘
- [ ] 로깅 레벨 관리
- [ ] 로그 파일 관리 (회전, 압축)
- [ ] 에러 알림 시스템

**파일 위치**:
- `managers/production_card_manager.py`: 에러 처리 개선
- `utils/logger.py`: 로깅 유틸리티 개선

### 10. 테스트 코드 작성

**현재 상태**: 테스트 코드 부족.

**업데이트 필요**:
- [ ] 단위 테스트 작성
  - 카드 생성/삭제 테스트
  - 히스토리 추가/조회 테스트
  - 점수 계산 테스트
- [ ] 통합 테스트 작성
  - 카드 생명주기 테스트
  - 중첩 카드 재활성 테스트
- [ ] 성능 테스트 작성
  - 대량 카드 처리 테스트
  - 동시성 테스트

**파일 위치**:
- 새 파일: `tests/test_production_card_manager.py`
- 새 파일: `tests/test_card_lifecycle.py`
- 새 파일: `tests/test_card_history.py`

### 11. 문서화 개선

**현재 상태**: 기본적인 README 작성 완료.

**업데이트 필요**:
- [ ] API 문서 작성
- [ ] 사용 예시 추가
- [ ] 트러블슈팅 가이드
- [ ] 아키텍처 다이어그램
- [ ] 데이터 흐름도

**파일 위치**:
- `README_PRODUCTION_CARD.md`: 문서 보완
- 새 파일: `DOC/API_REFERENCE.md`
- 새 파일: `DOC/TROUBLESHOOTING.md`

### 12. 설정 관리 개선

**현재 상태**: 기본적인 설정 관리.

**업데이트 필요**:
- [ ] 카드 관련 설정 통합 관리
  - 최대 카드 수
  - 자동 폐기 임계값
  - 히스토리 제한
- [ ] 설정 UI 추가
- [ ] 설정 검증 로직
- [ ] 설정 내보내기/가져오기

**파일 위치**:
- `managers/settings_manager.py`: 설정 관리 개선
- `ui/settings_dialog.py`: 설정 UI 추가

## 우선순위

### 높음 (즉시 필요)
1. **매수/매도 UI 개선** ⚠️ 긴급
   - 보유 상태 표시
   - 매도 버튼 명시적 추가
   - 포지션 정보 표시
   - 매수/매도 정보 개선
2. 점수 계산 로직 고도화
3. 히스토리 시스템 개선 (CANCEL 타입 추가)
4. 통계 및 분석 기능

### 중간 (단기)
5. 카드 필터링 및 정렬 기능
6. UI/UX 개선 (기타)
7. 자동 폐기 시스템 개선

### 낮음 (장기)
7. 강화학습 연동 개선
8. 성능 최적화
9. 테스트 코드 작성
10. 문서화 개선
11. 설정 관리 개선
12. 에러 처리 및 로깅

## 참고 문서

- `README_PRODUCTION_CARD.md`: 생산 카드 시스템 전체 문서
- `managers/card_lifecycle_spec.md`: 카드 생명주기 규격서
- `DOC/CARD_SCORE_RANK_SYSTEM.md`: 점수 및 등급 시스템 문서
- `managers/HISTORY_USAGE.md`: 히스토리 시스템 사용 가이드

