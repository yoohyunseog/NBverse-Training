<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì¹´ë“œ ì €ì¥/ì¡°íšŒ í…ŒìŠ¤íŠ¸</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #161c2b;
      --border: rgba(255, 255, 255, 0.08);
      --text: #e6eefc;
      --muted: #9aa0a6;
      --accent: #0ecb81;
      --accent-2: #4285f4;
      --danger: #f44336;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      background: var(--bg);
      color: var(--text);
      font-family: "Segoe UI", Arial, sans-serif;
    }
    h1 { margin: 0 0 24px; font-size: 32px; }
    h2 { margin: 24px 0 12px; font-size: 18px; color: var(--accent); }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .form-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input {
      background: #111827;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text);
      min-width: 120px;
    }
    button {
      background: var(--accent);
      color: #0b1220;
      border: none;
      border-radius: 8px;
      padding: 12px 16px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.danger {
      background: var(--danger);
      color: #fff;
    }
    .status {
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 14px;
      background: rgba(66, 133, 244, 0.1);
      border-left: 4px solid var(--accent-2);
      color: var(--accent-2);
    }
    .status.success {
      background: rgba(14, 203, 129, 0.1);
      border-left-color: var(--accent);
      color: var(--accent);
    }
    .status.error {
      background: rgba(244, 67, 54, 0.1);
      border-left-color: var(--danger);
      color: var(--danger);
    }
    .status.warning {
      background: rgba(255, 152, 0, 0.1);
      border-left-color: #ff9800;
      color: #ff9800;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 13px;
    }
    th {
      color: var(--muted);
      font-weight: 600;
      background: rgba(255, 255, 255, 0.02);
    }
    .code {
      background: #111827;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      margin: 8px 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
      max-height: 300px;
      overflow-y: auto;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin: 12px 0;
    }
    .stat {
      background: #111827;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }
    .stat-label { color: var(--muted); font-size: 11px; margin-bottom: 6px; }
    .stat-value { font-weight: 700; font-size: 18px; }
  </style>
</head>
<body>
  <h1>ğŸ§ª ì¹´ë“œ ì €ì¥/ì¡°íšŒ í…ŒìŠ¤íŠ¸</h1>

  <!-- ì¹´ë“œ ì €ì¥ ì„¹ì…˜ -->
  <div class="panel">
    <h2>1ï¸âƒ£ ì¹´ë“œ ì €ì¥í•˜ê¸°</h2>
    
    <div class="form-row">
      <div>
        <label for="price">ê°€ê²© (KRW)</label>
        <input type="number" id="price" placeholder="50000" value="50000" />
      </div>
      <div>
        <label for="nbValue">N/B ê°’</label>
        <input type="number" step="0.0000000001" id="nbValue" placeholder="0.1597275731" value="0.1597275731" />
      </div>
      <div>
        <label for="nbMax">N/B Max</label>
        <input type="number" step="0.0000000001" id="nbMax" placeholder="0.2379831565" value="0.2379831565" />
      </div>
      <div>
        <label for="nbMin">N/B Min</label>
        <input type="number" step="0.0000000001" id="nbMin" placeholder="0.0814719896" value="0.0814719896" />
      </div>
      <button id="saveBtn" onclick="saveCard()">ğŸ’¾ ì¹´ë“œ ì €ì¥</button>
    </div>
    
    <div id="saveStatus"></div>
    <div id="saveResult"></div>
  </div>

  <!-- ì¡°íšŒ ì„¹ì…˜ -->
  <div class="panel">
    <h2>2ï¸âƒ£ ì €ì¥ëœ ì¹´ë“œ ì¡°íšŒí•˜ê¸°</h2>
    
    <div class="form-row">
      <div>
        <label for="queryMin">N/B Min ì¡°íšŒ (ì €ì¥ëœ Minê³¼ ë¹„êµ)</label>
        <input type="number" step="0.0000000001" id="queryMin" placeholder="0.0814719896" value="" />
      </div>
      <div>
        <label for="queryMax">N/B Max ì¡°íšŒ (ì €ì¥ëœ Maxì™€ ë¹„êµ)</label>
        <input type="number" step="0.0000000001" id="queryMax" placeholder="0.2379831565" value="" />
      </div>
      <button id="queryBtn" onclick="queryCards()">ğŸ” ì¡°íšŒ</button>
    </div>
    
    <div id="queryStatus"></div>
    <div id="queryResult"></div>
  </div>

  <!-- í´ë” ê²½ë¡œ ì„¤ëª… -->
  <div class="panel">
    <h2>ğŸ“ ì €ì¥ ê²½ë¡œ êµ¬ì¡°</h2>
    <p style="color: var(--muted); margin-top: 0;">
      N/B ê°’ <code style="background: #111827; padding: 2px 6px; border-radius: 4px;">0.2604972083</code> ì¼ ë•Œ:
    </p>
    <div class="code">data/nbverse/max/0/2/6/0/4/9/7/2/0/8/3/0.2604972083_20260103_123456_123456.json</div>
    <p style="color: var(--muted); margin-bottom: 0;">
      ì†Œìˆ˜ì  ì´í›„ ê° ìë¦¿ìˆ˜ê°€ í´ë”ê°€ ë˜ì–´ ì €ì¥ë©ë‹ˆë‹¤.
    </p>
  </div>

  <!-- ìƒì„¸ ì •ë³´ -->
  <div class="panel">
    <h2>ğŸ“‹ ì €ì¥ëœ ì¹´ë“œ ìƒì„¸</h2>
    <div id="cardDetails">
      <p style="color: var(--muted);">ì €ì¥ëœ ì¹´ë“œ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://127.0.0.1:5000/api';
    let lastSavedCard = null;

    const formatNb = (value) => Number.isFinite(value) ? value.toFixed(10) : '-';

    function showStatus(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      el.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function formatJson(obj) {
      return JSON.stringify(obj, null, 2);
    }

    async function saveCard() {
      const price = parseFloat(document.getElementById('price').value);
      const nbValue = parseFloat(document.getElementById('nbValue').value);
      const nbMax = parseFloat(document.getElementById('nbMax').value);
      const nbMin = parseFloat(document.getElementById('nbMin').value);

      if (!price || !nbValue || !nbMax || !nbMin) {
        showStatus('saveStatus', 'âš ï¸ ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }

      showStatus('saveStatus', 'ğŸ’« ì¹´ë“œë¥¼ ì €ì¥í•˜ëŠ” ì¤‘...', 'info');
      document.getElementById('saveBtn').disabled = true;

      try {
        const response = await fetch(`${API_BASE_URL}/cards/chart-analysis/save`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            card_type: 'card2',
            timeframe: 'minute10',
            card_data: {
              price: price,
              nb_value: nbValue,
              nb_max: nbMax,
              nb_min: nbMin,
              timestamp: new Date().toISOString(),
              ema_fast: 50000,
              ema_slow: 48000,
              production_date: new Date().toISOString()
            }
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          lastSavedCard = {
            ...result,
            card_data: {
              price: price,
              nb_value: nbValue,
              nb_max: nbMax,
              nb_min: nbMin,
              timestamp: new Date().toISOString()
            }
          };
          showStatus('saveStatus', `âœ… ì¹´ë“œ ì €ì¥ ì™„ë£Œ! card_id: ${result.card_id}`, 'success');
          
          const html = `
            <div class="grid">
              <div class="stat">
                <div class="stat-label">ì¹´ë“œ ID</div>
                <div class="stat-value" style="font-size: 12px; overflow: hidden; text-overflow: ellipsis;">${result.card_id}</div>
              </div>
              <div class="stat">
                <div class="stat-label">ì¹´ë“œ í‚¤</div>
                <div class="stat-value" style="font-size: 12px; overflow: hidden; text-overflow: ellipsis;">${result.card_key}</div>
              </div>
              <div class="stat">
                <div class="stat-label">ì¤‘ì²© ì—¬ë¶€</div>
                <div class="stat-value">${result.is_overlap ? 'ğŸ”„ ì¤‘ì²©' : 'âœ¨ ìƒˆ ì¹´ë“œ'}</div>
              </div>
            </div>
            <p><strong>MAX ê²½ë¡œ:</strong></p>
            <div class="code">${result.max_path || 'N/A'}</div>
            <p><strong>MIN ê²½ë¡œ:</strong></p>
            <div class="code">${result.min_path || 'N/A'}</div>
            <p><strong>ì „ì²´ ì‘ë‹µ:</strong></p>
            <div class="code">${formatJson(result)}</div>
          `;
          document.getElementById('saveResult').innerHTML = html;

          // ì¹´ë“œ ìƒì„¸ í‘œì‹œ
          document.getElementById('cardDetails').innerHTML = `
            <div class="grid">
              <div class="stat">
                <div class="stat-label">ê°€ê²©</div>
                <div class="stat-value">${price.toLocaleString()} ì›</div>
              </div>
              <div class="stat">
                <div class="stat-label">N/B ê°’</div>
                <div class="stat-value">${nbValue.toFixed(10)}</div>
              </div>
              <div class="stat">
                <div class="stat-label">N/B Max</div>
                <div class="stat-value">${nbMax.toFixed(10)}</div>
              </div>
              <div class="stat">
                <div class="stat-label">N/B Min</div>
                <div class="stat-value">${nbMin.toFixed(10)}</div>
              </div>
            </div>
          `;
        } else {
          showStatus('saveStatus', `âŒ ì €ì¥ ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'error');
          document.getElementById('saveResult').innerHTML = `<div class="code">${formatJson(result)}</div>`;
        }
      } catch (error) {
        showStatus('saveStatus', `âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
        document.getElementById('saveResult').innerHTML = `<div class="code">${error.message}</div>`;
      } finally {
        document.getElementById('saveBtn').disabled = false;
      }
    }

    async function queryCards() {
      const minVal = parseFloat(document.getElementById('queryMin').value);
      const maxVal = parseFloat(document.getElementById('queryMax').value);

      // minê³¼ max ì¤‘ ìµœì†Œ í•˜ë‚˜ëŠ” ì…ë ¥ë˜ì–´ì•¼ í•¨
      if (!Number.isFinite(minVal) && !Number.isFinite(maxVal)) {
        showStatus('queryStatus', 'âš ï¸ N/B Min ë˜ëŠ” Max ì¤‘ ìµœì†Œ í•˜ë‚˜ëŠ” ì…ë ¥í•´ì£¼ì„¸ìš”. (ì†Œìˆ˜ì  10ìë¦¬ê¹Œì§€ ì…ë ¥)', 'warning');
        return;
      }

      showStatus('queryStatus', 'ğŸ” ì¹´ë“œë¥¼ ì¡°íšŒí•˜ëŠ” ì¤‘...', 'info');
      document.getElementById('queryBtn').disabled = true;

      try {
        const hasMin = Number.isFinite(minVal);
        const hasMax = Number.isFinite(maxVal);

        const payload = {
          nb_min: hasMin ? minVal : undefined,
          nb_max: hasMax ? maxVal : undefined,
          limit: 20
        };

        const queryType = hasMin && hasMax
          ? 'Min & Max ë²”ìœ„ ì¡°íšŒ'
          : hasMin
            ? 'Min ê¸°ì¤€ ì¡°íšŒ'
            : 'Max ê¸°ì¤€ ì¡°íšŒ';

        const rangeText = hasMin && hasMax
          ? `ì €ì¥ëœ Min â‰¥ ${minVal.toFixed(10)} AND ì €ì¥ëœ Max â‰¤ ${maxVal.toFixed(10)}`
          : hasMin
            ? `ì €ì¥ëœ NB_Min â‰¥ ${minVal.toFixed(10)}`
            : `ì €ì¥ëœ NB_Max â‰¤ ${maxVal.toFixed(10)}`;

        const response = await fetch(`${API_BASE_URL}/cards/chart-analysis/query`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        let result;
        try {
          result = await response.json();
        } catch (e) {
          const text = await response.text();
          throw new Error(`ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨ (status ${response.status}): ${text}`);
        }

        if (!response.ok || result.error) {
          throw new Error(result?.error || `HTTP ${response.status}`);
        }

        const cards = result.cards || [];

        showStatus('queryStatus', `âœ… ì¡°íšŒ ì™„ë£Œ! ${cards.length}ê°œì˜ ì¹´ë“œ ë°œê²¬ (ìŠ¤ìº” ${result.scanned_files ?? '?'} / ${result.max_scan ?? '?'})`, 'success');

        let resultsHtml = `
          <h3 style="margin-top: 16px; color: var(--text);">ì¡°íšŒ ì¡°ê±´:</h3>
          <table>
            <tr>
              <th>í•­ëª©</th>
              <th>ê°’</th>
            </tr>
            <tr>
              <td>ì¡°íšŒ ìœ í˜•</td>
              <td><strong>${queryType}</strong></td>
            </tr>
            <tr>
              <td>ì¡°íšŒ ë²”ìœ„</td>
              <td><strong>${rangeText}</strong></td>
            </tr>
            <tr>
              <td>ì…ë ¥ëœ Min</td>
              <td>${hasMin ? minVal.toFixed(10) : '(ì…ë ¥ ì•ˆ í•¨)'}</td>
            </tr>
            <tr>
              <td>ì…ë ¥ëœ Max</td>
              <td>${hasMax ? maxVal.toFixed(10) : '(ì…ë ¥ ì•ˆ í•¨)'}</td>
            </tr>
          </table>
        `;

        if (cards.length > 0) {
          resultsHtml += `
            <h3 style="margin-top: 16px; color: var(--accent);">ğŸ¯ ì¡°íšŒ ê²°ê³¼ (${cards.length}ê°œ)</h3>
            <table>
              <tr>
                <th>ì¹´ë“œ ID</th>
                <th>Timeframe</th>
                <th>NB_Min</th>
                <th>NB_Max</th>
              </tr>
          `;
          cards.forEach(card => {
            const data = card.card_data || card;
            const nbMin = data?.nb_min ?? data?.nbMin ?? card.nb_min ?? card.nbMin;
            const nbMax = data?.nb_max ?? data?.nbMax ?? card.nb_max ?? card.nbMax;
            resultsHtml += `
              <tr>
                <td style="font-size: 11px; word-break: break-all;">${card.card_id || card.id || '(ì—†ìŒ)'}</td>
                <td>${card.timeframe || data.productionTimeframe || '-'}</td>
                <td>${formatNb(nbMin)}</td>
                <td>${formatNb(nbMax)}</td>
              </tr>
            `;
          });
          resultsHtml += `</table>`;
        } else {
          resultsHtml += `
            <h3 style="margin-top: 16px; color: var(--danger);">âŒ ì¡°íšŒ ê²°ê³¼</h3>
            <div class="status error">
              ì €ì¥ëœ ì¹´ë“œê°€ ì¡°íšŒ ì¡°ê±´ê³¼ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </div>
          `;
        }

        document.getElementById('queryResult').innerHTML = resultsHtml;
      } catch (error) {
        showStatus('queryStatus', `âŒ ì˜¤ë¥˜: ${error.message}`, 'error');
      } finally {
        document.getElementById('queryBtn').disabled = false;
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì •ë³´ í‘œì‹œ
    window.addEventListener('load', () => {
      document.getElementById('cardDetails').innerHTML = `
        <p style="color: var(--muted);">ìœ„ì—ì„œ ì¹´ë“œë¥¼ ì €ì¥í•œ í›„ ì €ì¥ëœ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
      `;
    });
  </script>
</body>
</html>
